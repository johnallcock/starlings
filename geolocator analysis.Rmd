---
title: "R Notebook"
output: html_notebook
---

#Load required packages
```{r}
library(GeoLight)
library(raster)
library(rnaturalearth)
library(ggplot2)
library(dplyr)
library(sf)
sf_use_s2(FALSE) 
library(devtools)
library(usethis)
library(processx)
library(sgat)
library(zoo)

```


#Import the .lux files (use drift adjusted where possible)
```{r}
SSIN_872 <- luxTrans("CB872_11May22_081102driftadj.lux") 
SSIN_878 <- luxTrans("CB878_11May22_082526driftadj.lux") 
SSIN_874 <- luxTrans("CB874_20May22_034702driftadj.lux")
SSIN_884 <- luxTrans("CB884_24May22_014703driftadj.lux") 
SSIN_880 <- luxTrans("CB880_31May22_012458driftadj.lux")
SSIN_876 <- luxTrans("CB876_05Jun22_224306driftadj.lux")
SSIN_867 <- luxTrans("CB867_15Jul22_054342driftadj.lux")
SSIN_875 <- luxTrans("CB875_21Sep22_185524.lux")

SSIN_872$datetime <- as.POSIXct(strptime(SSIN_872$datetime, format = "%Y-%m-%d %H:%M:%S", tz = "GMT"))
SSIN_878$datetime <- as.POSIXct(strptime(SSIN_878$datetime, format = "%Y-%m-%d %H:%M:%S",  tz = "GMT"))
SSIN_874$datetime <- as.POSIXct(strptime(SSIN_874$datetime, format = "%Y-%m-%d %H:%M:%S",  tz = "GMT"))
SSIN_884$datetime <- as.POSIXct(strptime(SSIN_884$datetime, format = "%Y-%m-%d %H:%M:%S",  tz = "GMT"))
SSIN_880$datetime <- as.POSIXct(strptime(SSIN_880$datetime, format = "%Y-%m-%d %H:%M:%S",  tz = "GMT"))
SSIN_876$datetime <- as.POSIXct(strptime(SSIN_876$datetime, format = "%Y-%m-%d %H:%M:%S",  tz = "GMT"))
SSIN_867$datetime <- as.POSIXct(strptime(SSIN_867$datetime, format = "%Y-%m-%d %H:%M:%S",  tz = "GMT"))
SSIN_875$datetime <- as.POSIXct(strptime(SSIN_875$datetime, format = "%Y-%m-%d %H:%M:%S",  tz = "GMT"))


```


```{r}
SSIN_867_transitions<- twilightCalc(SSIN_867$datetime, SSIN_867$light, LightThreshold=5,ask=TRUE)
SSIN_872_transitions<- twilightCalc(SSIN_872$datetime, SSIN_872$light, LightThreshold=5,ask=TRUE)
SSIN_874_transitions<- twilightCalc(SSIN_874$datetime, SSIN_874$light, LightThreshold=5,ask=TRUE)
SSIN_875_transitions<- twilightCalc(SSIN_875$datetime, SSIN_875$light, LightThreshold=5,ask=TRUE)
SSIN_876_transitions<- twilightCalc(SSIN_876$datetime, SSIN_876$light, LightThreshold=5,ask=TRUE)
SSIN_878_transitions<- twilightCalc(SSIN_878$datetime, SSIN_878$light, LightThreshold=5,ask=TRUE)
SSIN_880_transitions<- twilightCalc(SSIN_880$datetime, SSIN_880$light, LightThreshold=5,ask=TRUE)
SSIN_884_transitions<- twilightCalc(SSIN_884$datetime, SSIN_884$light, LightThreshold=5,ask=TRUE)


SSIN_875_transitions <- SSIN_875_transitions[-c(709:716),] #This removes records at the end when the tag malfunctioned

subset(SSIN_867_transitions, tFirst > as.POSIXct("2021-07-23", format = "%Y-%m-%d") & tSecond < as.POSIXct("2021-07-26", format = "%Y-%m-%d"))

write.csv(SSIN_867_transitions, "SSIN_867_transitions.csv")
write.csv(SSIN_875_transitions, "SSIN_875_transitions.csv")

```



#Import transitions files
```{r}
import_transition <- function(transition_file) {
  transition <- read.csv (transition_file, row.names=1, header = T)
  transition$tFirst <- as.POSIXct(strptime(transition$tFirst, format = "%Y-%m-%d %H:%M:%S",  tz = "GMT"))
  transition$tSecond <- as.POSIXct(strptime(transition$tSecond, format = "%Y-%m-%d %H:%M:%S",  tz = "GMT"))
  
  return(transition)
}

SSIN_867_transitions <- import_transition("SSIN_867_transitions.csv")
SSIN_872_transitions <- import_transition("SSIN_872_transitions.csv")
SSIN_874_transitions <- import_transition("SSIN_874_transitions.csv")
SSIN_875_transitions <- import_transition("SSIN_875_transitions.csv")
SSIN_876_transitions <- import_transition("SSIN_876_transitions.csv")
SSIN_878_transitions <- import_transition("SSIN_878_transitions.csv")
SSIN_880_transitions <- import_transition("SSIN_880_transitions.csv")
SSIN_884_transitions <- import_transition("SSIN_884_transitions.csv")

```

#Set up function to remove uncertain locations during equinox
```{r}
equinox_remove <- function(file) {
  aut_equinox_start <- as.POSIXct("2021-09-09", format = "%Y-%m-%d",  tz = "GMT")
  aut_equinox_end <- as.POSIXct("2021-10-07", format = "%Y-%m-%d",  tz = "GMT")
  spr_equinox_start <- as.POSIXct("2022-03-06", format = "%Y-%m-%d",  tz = "GMT")
  spr_equinox_end <- as.POSIXct("2022-04-03", format = "%Y-%m-%d",  tz = "GMT")
  
  clipped <- subset(file, tFirst < aut_equinox_start | (tSecond > aut_equinox_end & tFirst < spr_equinox_start) | tSecond > spr_equinox_end)
  return(clipped)

}

SSIN_867_transitions_clip <- equinox_remove(SSIN_867_transitions)
SSIN_872_transitions_clip <- equinox_remove(SSIN_872_transitions)
SSIN_874_transitions_clip <- equinox_remove(SSIN_874_transitions)
SSIN_875_transitions_clip <- equinox_remove(SSIN_875_transitions)
SSIN_876_transitions_clip <- equinox_remove(SSIN_876_transitions)
SSIN_878_transitions_clip <- equinox_remove(SSIN_878_transitions)
SSIN_880_transitions_clip <- equinox_remove(SSIN_880_transitions)
SSIN_884_transitions_clip <- equinox_remove(SSIN_884_transitions)


```

#Introduce Loess function to remove outliers
```{r}
loess_remove <- function(file) {
  keep <- loessFilter(file,k = 1, plot = F)
  clipped <- file[keep,]
  
  return(clipped)
}

SSIN_867_transitions_clip2 <- loess_remove(SSIN_867_transitions_clip)
SSIN_872_transitions_clip2 <- loess_remove(SSIN_872_transitions_clip)
SSIN_874_transitions_clip2 <- loess_remove(SSIN_874_transitions_clip)
SSIN_875_transitions_clip2 <- loess_remove(SSIN_875_transitions_clip)
SSIN_876_transitions_clip2 <- loess_remove(SSIN_876_transitions_clip)
SSIN_878_transitions_clip2 <- loess_remove(SSIN_878_transitions_clip)
SSIN_880_transitions_clip2 <- loess_remove(SSIN_880_transitions_clip)
SSIN_884_transitions_clip2 <- loess_remove(SSIN_884_transitions_clip)

```

#If we are happy with the above filters, the import and filtering can be simplified to this equation
```{r}
SSIN_867_transitions_clipb <-
  loess_remove(equinox_remove(import_transition("SSIN_867_transitions.csv")))
SSIN_872_transitions_clipb <-
  loess_remove(equinox_remove(import_transition("SSIN_872_transitions.csv")))
SSIN_874_transitions_clipb <-
  loess_remove(equinox_remove(import_transition("SSIN_874_transitions.csv")))
SSIN_875_transitions_clipb <-
  loess_remove(equinox_remove(import_transition("SSIN_875_transitions.csv")))
SSIN_876_transitions_clipb <-
  loess_remove(equinox_remove(import_transition("SSIN_876_transitions.csv")))
SSIN_878_transitions_clipb <-
  loess_remove(equinox_remove(import_transition("SSIN_878_transitions.csv")))
SSIN_880_transitions_clipb <-
  loess_remove(equinox_remove(import_transition("SSIN_880_transitions.csv")))
SSIN_884_transitions_clipb <-
  loess_remove(equinox_remove(import_transition("SSIN_884_transitions.csv")))

```


# calculate the sun elevation angle. I used SSIN 880 because it is the one that worked the best.
#The first equation here is the equation that Pia has used:
the calibration days do not seem to work very well with the model, and so I estimated the time where the bird would be at the site at the end of the season. 
#The two functions are something John's written to calculate sun elevation based on the calibration periods at the start and the end.
#THESE TWO APPROACHES GIVE DIFFERENT RESULTS. WE NEED TO WORK OUT WHICH IS BEST!
```{r}
SunElev880<-getElevation(tFirst=SSIN_880_transitions[613:730,1],
                         tSecond = SSIN_880_transitions[613:730,2],
                         type = SSIN_880_transitions[613:730,3],
                         known.coord=c(114.07,22.5),
                         plot=TRUE, method="gamma")
?getElevation
tail(SSIN_872_transitions)
SSIN_872_transitions[1:14,]

calibrate <- function(file, start1, end1, start2, end2) {
  subset <- subset(file, (tFirst > as.POSIXct(start1, format = "%Y-%m-%d %H:%M") & tSecond < as.POSIXct(end1, format = "%Y-%m-%d %H:%M")) | (tFirst > as.POSIXct(start2, format = "%Y-%m-%d %H:%M") & tSecond < as.POSIXct(end2, format = "%Y-%m-%d %H:%M")))
  calib <- getElevation(tFirst = subset[,1],
                         tSecond = subset[,2],
                         type = subset[,3],
                         known.coord=c(114.140,22.445),
                         plot=TRUE, method="gamma")
  return(calib)
}

calibrate <- function(file, start1, end1) {
  subset <- subset(file, (tFirst > as.POSIXct(start1, format = "%Y-%m-%d %H:%M") & tSecond < as.POSIXct(end1, format = "%Y-%m-%d %H:%M")))
  calib <- getElevation(tFirst = subset[,1],
                         tSecond = subset[,2],
                         type = subset[,3],
                         known.coord=c(114.140,22.445),
                         plot=TRUE, method="gamma")
  return(calib)
}


SunElev872 <- calibrate(SSIN_872_transitions, "2021-05-30 16:00", "2021-06-07 16:00", "2022-05-06 16:00", "2022-05-10 16:00")
SunElev872 <- calibrate(SSIN_872_transitions[-c(6,7),], "2021-05-30 16:00", "2021-06-07 16:00")
str(SunElev872)

SunElev875 <- calibrate(SSIN_875_transitions, "2021-05-18 16:00", "2021-05-26 16:00")
str(SunElev872)

  subset <- subset(SSIN_875_transitions, (tFirst > as.POSIXct("2021-05-18 16:00", format = "%Y-%m-%d %H:%M") & tSecond < as.POSIXct("2021-05-26 16:00", format = "%Y-%m-%d %H:%M")))
  calib <- getElevation(tFirst = subset[,1],
                         tSecond = subset[,2],
                         type = subset[,3],
                         known.coord=c(114.140,22.445),
                         plot=TRUE, method="gamma")


getElevation(twl = subset(SSIN_875_transitions, (tFirst > as.POSIXct("2021-05-18 16:00", format = "%Y-%m-%d %H:%M") & tSecond < as.POSIXct("2021-05-26 16:00", format = "%Y-%m-%d %H:%M"))), known.coord=c(114.140,22.445), method = "gamma", plot = FALSE)  
  
```


#Function to estimate the locations for each individual
This uses the elevation Pia calculated. We should confirm that this is correct, instead of recalculating for each bird
```{r}
get_location <- function(file, individual) {
 locations <- coord(file$tFirst, file$tSecond, file$type, degElevation=-4.172)
 locations_df <- as.data.frame(locations)
 locations_df$Date <- as.Date.POSIXct(file$tFirst)
 locations_df$Individual <- individual
 locations_df <- locations_df[,c(4,3,1,2)]
   
 return(locations_df)
}

SSIN_867_locations <- get_location(SSIN_867_transitions_clip2, "872")
SSIN_872_locations <- get_location(SSIN_872_transitions_clip2, "872")
SSIN_874_locations <- get_location(SSIN_874_transitions_clip2, "874")
SSIN_875_locations <- get_location(SSIN_875_transitions_clip2, "872")
SSIN_876_locations <- get_location(SSIN_876_transitions_clip2, "876")
SSIN_878_locations <- get_location(SSIN_878_transitions_clip2, "878")
SSIN_880_locations <- get_location(SSIN_880_transitions_clip2, "880")
SSIN_884_locations <- get_location(SSIN_884_transitions_clip2, "884")

SSIN_867_locations2 <- get_location(SSIN_867_transitions, "867")
SSIN_872_locations2 <- get_location(SSIN_872_transitions, "872")
SSIN_874_locations2 <- get_location(SSIN_874_transitions, "874")
SSIN_875_locations2 <- get_location(SSIN_875_transitions, "875")
SSIN_876_locations2 <- get_location(SSIN_876_transitions, "876")
SSIN_878_locations2 <- get_location(SSIN_878_transitions, "878")
SSIN_880_locations2 <- get_location(SSIN_880_transitions, "880")
SSIN_884_locations2 <- get_location(SSIN_884_transitions, "884")


```


#Calculate rolling means of locations
- I've included this for 3, 5 and 10 days, we can adjust to other frequencies. 
- May help to simplify some of the results and reduce noise, but it may not be necessary
```{r}
rolling <- function(location_file) {
  rolling <- location_file %>%
  mutate(lon3day = rollmean(lon, k=3, fill=NA, align='right')) %>%
  mutate(lat3day = rollmean(lat, k=3, fill=NA, align='right')) %>%
  mutate(lon5day = rollmean(lon, k=5, fill=NA, align='right')) %>%
  mutate(lat5day = rollmean(lat, k=5, fill=NA, align='right')) %>%
  mutate(lon10day = rollmean(lon, k=10, fill=NA, align='right')) %>%
  mutate(lat10day = rollmean(lat, k=10, fill=NA, align='right'))

  return(rolling)
}

SSIN_867_rolling <- rolling(SSIN_867_locations)
SSIN_872_rolling <- rolling(SSIN_872_locations)
SSIN_874_rolling <- rolling(SSIN_874_locations)
SSIN_875_rolling <- rolling(SSIN_875_locations)
SSIN_876_rolling <- rolling(SSIN_876_locations)
SSIN_878_rolling <- rolling(SSIN_878_locations)
SSIN_880_rolling <- rolling(SSIN_880_locations)
SSIN_884_rolling <- rolling(SSIN_884_locations)

```


#Graphs showing longitude (actual and smoothed over 5 days) to estimate migration dates
Equinox periods shaded as grey
```{r}
equinox_graph <- ggplot() +
  geom_rect(aes(xmin = as.Date("2021-09-09", format = "%Y-%m-%d"), xmax = as.Date("2021-10-07", format = "%Y-%m-%d"), ymin = -Inf, ymax = Inf)) +
  geom_rect(aes(xmin = as.Date("2022-03-06", format = "%Y-%m-%d"), xmax = as.Date("2022-04-03", format = "%Y-%m-%d"), ymin = -Inf, ymax = Inf))

equinox_graph + geom_line(data = SSIN_867_rolling, aes(x = Date, y = lon))
equinox_graph + geom_line(data = SSIN_872_rolling, aes(x = Date, y = lon))
equinox_graph + geom_line(data = SSIN_874_rolling, aes(x = Date, y = lon))
equinox_graph + geom_line(data = SSIN_875_rolling, aes(x = Date, y = lon))
equinox_graph + geom_line(data = SSIN_876_rolling, aes(x = Date, y = lon))
equinox_graph + geom_line(data = SSIN_878_rolling, aes(x = Date, y = lon))
equinox_graph + geom_line(data = SSIN_880_rolling, aes(x = Date, y = lon))
equinox_graph + geom_line(data = SSIN_884_rolling, aes(x = Date, y = lon))

```

#Reaching clear estimates of migration dates, based on longitude
```{r}
equinox_graph + geom_line(data = SSIN_867_locations2, aes(x = Date, y = lon)) + scale_y_continuous(limits = c(100, 125))
subset(SSIN_867_locations2, (Date >= as.Date("2021-09-14") & Date <= as.Date("2021-09-16")))
subset(SSIN_867_locations2, (Date >= as.Date("2022-03-19") & Date <= as.Date("2022-03-21")))
#Westward movement on 15 September, eastward movement on 20 March

equinox_graph + geom_line(data = SSIN_872_locations2, aes(x = Date, y = lon)) + scale_y_continuous(limits = c(100, 125))
subset(SSIN_872_locations2, (Date >= as.Date("2021-09-04") & Date <= as.Date("2021-09-07")))
subset(SSIN_872_locations2, (Date >= as.Date("2022-03-17") & Date <= as.Date("2022-03-19")))
#Eastward movement on 4 September, westward movement on 18 March

equinox_graph + geom_line(data = SSIN_874_locations2, aes(x = Date, y = lon)) + scale_y_continuous(limits = c(100, 125))
subset(SSIN_874_locations2, (Date >= as.Date("2021-09-01") & Date <= as.Date("2021-09-03")))
subset(SSIN_874_locations2, (Date >= as.Date("2022-03-08") & Date <= as.Date("2022-03-10")))
#Westward movement on 02 September, eastward movement on 09 March

equinox_graph + geom_line(data = SSIN_875_locations2, aes(x = Date, y = lon)) + scale_y_continuous(limits = c(100, 125))
subset(SSIN_875_locations2, (Date >= as.Date("2021-09-17") & Date <= as.Date("2021-09-19")))
subset(SSIN_875_locations2, (Date >= as.Date("2022-03-23") & Date <= as.Date("2022-03-27")))
#Westward movement on 18 September, eastward movement on 24-26 March

equinox_graph + geom_line(data = SSIN_876_locations2, aes(x = Date, y = lon)) + scale_y_continuous(limits = c(100, 125))
subset(SSIN_876_locations2, (Date >= as.Date("2021-09-17") & Date <= as.Date("2021-09-19")))
subset(SSIN_876_locations2, (Date >= as.Date("2022-03-23") & Date <= as.Date("2022-03-26")))
#Westward movement on 18 September, eastward movement on 24-25 March

equinox_graph + geom_line(data = SSIN_878_locations2, aes(x = Date, y = lon)) + scale_y_continuous(limits = c(100, 125))
subset(SSIN_878_locations2, (Date >= as.Date("2021-09-17") & Date <= as.Date("2021-09-20")))
subset(SSIN_878_locations2, (Date >= as.Date("2022-04-09") & Date <= as.Date("2022-04-13")))
#Westward movement on 18-19 September, eastward movement on 09-13 April

equinox_graph + geom_line(data = SSIN_880_locations2, aes(x = Date, y = lon)) + scale_y_continuous(limits = c(100, 125))
subset(SSIN_880_locations2, (Date >= as.Date("2021-09-03") & Date <= as.Date("2021-09-11")))
subset(SSIN_880_locations2, (Date >= as.Date("2022-03-24") & Date <= as.Date("2022-03-26")))
#Westward movement on 04-10 September, eastward movement on 25 March

equinox_graph + geom_line(data = SSIN_884_locations2, aes(x = Date, y = lon)) + scale_y_continuous(limits = c(100, 125))
subset(SSIN_884_locations2, (Date >= as.Date("2021-09-02") & Date <= as.Date("2021-09-06")))
subset(SSIN_884_locations2, (Date >= as.Date("2022-03-21") & Date <= as.Date("2022-03-26")))
#Westward movement on 03-06 September, eastward movement on 22-25 March


```


#Sets up a background map cropped to approriate area to use for creating maps
```{r}
worldmap <- rnaturalearth::ne_countries(scale="medium", returnclass="sf")     
background_map <- ggplot() + 
  geom_sf(data = worldmap, fill="grey30", lwd=0.1, projection=st_crs("+proj=longlat +datum=WGS84"))+         
  coord_sf(xlim=c(100,130), ylim=c(5,35))                                       

background_map
```


#Creates a map with all birds, showing data points between the two equinox periods
```{r}
background_map +
  geom_point(data=subset(SSIN_867_rolling, Date > "2021-10-08" & Date < "2022-03-05"), aes(x=lon, y=lat,colour="867"), size=1, shape=20)+
  geom_point(data=subset(SSIN_872_rolling, Date > "2021-10-08" & Date < "2022-03-05"), aes(x=lon, y=lat,colour="872"), size=1, shape=20)+
  geom_point(data=subset(SSIN_874_rolling, Date > "2021-10-08" & Date < "2022-03-05"), aes(x=lon, y=lat,colour="874"), size=1, shape=20)+
  geom_point(data=subset(SSIN_875_rolling, Date > "2021-10-08" & Date < "2022-03-05"), aes(x=lon, y=lat,colour="875"), size=1, shape=20)+
  geom_point(data=subset(SSIN_876_rolling, Date > "2021-10-08" & Date < "2022-03-05"), aes(x=lon, y=lat,colour="876"), size=1, shape=20)+
  geom_point(data=subset(SSIN_878_rolling, Date > "2021-10-08" & Date < "2022-03-05"), aes(x=lon, y=lat,colour="878"), size=1, shape=20)+
  geom_point(data=subset(SSIN_880_rolling, Date > "2021-10-08" & Date < "2022-03-05"), aes(x=lon, y=lat,colour="880"), size=1, shape=20)+
  geom_point(data=subset(SSIN_884_rolling, Date > "2021-10-08" & Date < "2022-03-05"), aes(x=lon, y=lat,colour="884"), size=1, shape=20)

str(SSIN_878_rolling)
```

#Creates a map with all birds showing an ellipse for the period January-February (mid-winter range)
```{r}
background_map +
  stat_ellipse(data=subset(SSIN_867_rolling, Date > "2021-12-01" & Date < "2022-01-31"), aes(x=lon, y=lat,colour="867"), size=1, shape=20)+
  stat_ellipse(data=subset(SSIN_872_rolling, Date > "2021-12-01" & Date < "2022-01-31"), aes(x=lon, y=lat,colour="872"), size=1, shape=20)+
  stat_ellipse(data=subset(SSIN_874_rolling, Date > "2021-12-01" & Date < "2022-01-31"), aes(x=lon, y=lat,colour="874"), size=1, shape=20)+
  stat_ellipse(data=subset(SSIN_875_rolling, Date > "2021-12-01" & Date < "2022-01-31"), aes(x=lon, y=lat,colour="875"), size=1, shape=20)+
  stat_ellipse(data=subset(SSIN_876_rolling, Date > "2021-12-01" & Date < "2022-01-31"), aes(x=lon, y=lat,colour="876"), size=1, shape=20)+
  stat_ellipse(data=subset(SSIN_878_rolling, Date > "2021-12-01" & Date < "2022-01-31"), aes(x=lon, y=lat,colour="878"), size=1, shape=20)+
  stat_ellipse(data=subset(SSIN_880_rolling, Date > "2021-12-01" & Date < "2022-01-31"), aes(x=lon, y=lat,colour="880"), size=1, shape=20)+
  stat_ellipse(data=subset(SSIN_884_rolling, Date > "2021-12-01" & Date < "2022-01-31"), aes(x=lon, y=lat,colour="884"), size=1, shape=20)

```


#This draws the ellipse for each month for an individual. I need to adjust how to deal with aesthetics (currently all ellipses are the same colour!)
```{r}
date_ellipse <- function(file, start_date, end_date) {
  date_ellipse <- stat_ellipse(data=subset(file, Date > start_date & Date < end_date), aes(x=lon, y=lat), size=1, shape=20)
  
  return(date_ellipse)
}  

background_map +
  date_ellipse(SSIN_874_rolling, "2021-09-01", "2021-09-30") +
  date_ellipse(SSIN_874_rolling, "2021-10-01", "2021-10-31") +
  date_ellipse(SSIN_874_rolling, "2021-11-01", "2021-11-30") +
  date_ellipse(SSIN_874_rolling, "2021-12-01", "2021-12-31") +
  date_ellipse(SSIN_874_rolling, "2022-01-01", "2022-01-31") +
  date_ellipse(SSIN_874_rolling, "2022-02-01", "2022-02-28") +
  date_ellipse(SSIN_874_rolling, "2022-03-01", "2022-03-31")


```

